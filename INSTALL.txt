=====================
Installing Whitetrash
=====================

Checkout the code:

    svn co https://whitetrash.svn.sourceforge.net/svnroot/whitetrash/trunk whitetrash

The packages you will need (this is an Ubuntu/debian command line, but other distros will be similar) are:

    sudo apt-get install \
    squid \
    python-dev \
    python-mysqldb \
    python-pyopenssl \
    mysql-server \
    python-django \
    libapache2-mod-python

    cd whitetrash

edit whitetrash.conf:

 - Change all of the database user passwords, these users will be created for you by the installation script

Run the setup script and supply your DB root password:

    sudo python setup.py install --mysql-root-passwd="myrootpassword"

Enable apache ssl and modrewrite modules:

    sudo a2enmod ssl rewrite

Restart apache and squid, start whitetrash_cert:
    /etc/init.d/apache2 restart
    /etc/init.d/squid restart
    /etc/init.d/whitetrash_cert start

Make sure the whitetrash_cert server gets started in the default runlevels by (on ubuntu):

    sudo update-rc.d whitetrash_cert defaults

If you would like to enable the CAPTCHA (http://en.wikipedia.org/wiki/Captcha) test for whitelist additions, you will need to install PyCAPTCHA: http://cheeseshop.python.org/pypi/PyCAPTCHA/0.4  using easy_install (python-setuptools) and the python-imaging package.

LDAP
~~~~

To enable LDAP authentication:

    - install the python-ldap package
    - set LDAP_AUTH = "True" in whitetrash.conf
    - change the LDAP entries in django_site/whitetrash/settings.py 

Squid Config
~~~~~~~~~~~~

An example config with comments has been installed in /etc/squid/squid.conf, you probably don't need to change anything in here.
If you have a large network, check the performance section below.
This config is for Squid 2.7.STABLE3.  Your original squid.conf is backed up in the same directory.  You may want to use vimdiff on the whitetrash and package conf file to pull in any options from newer versions of squid.

The result
~~~~~~~~~~

netstat -plant should show you the following listeners:

- python (whitetrash_cert)  127.0.0.1:3456
- mysqld                    127.0.0.1:3306
- squid                     0.0.0.0:3128
- apache                    0.0.0.0:80, 0.0.0.0:443

DNS
~~~

Make sure the following domains resolve to the whitetrash IP:

 - whitetrash
 - sslwhitetrash
 - blockedwhitetrash

You can do this with /etc/hosts if you don't have DNS:

    127.0.0.1   localhost whitetrash sslwhitetrash blockedwhitetrash

===========
Performance
===========

Django
------

By default the whole web-interface uses SSL.  If this causes a performance problem you can drop back to HTTP for everything except for the login pages and admin interface by:

 - Removing the rewrite directives from /etc/apache2/sites-available/whitetrash
 - Setting ssl_server_enabled = "False" in whitetrash.conf 

MySQL
-----

If you have a lot of users, you will want to look at tweaking your mysql install, in particular the max number of connections (100 by default).  Set max_connections in my.cnf or test on the commandline temporarily like this::

  set global max_connections=200;

You should probably allocate mysql some more system resources, as the defaults are fairly conservative.  See mysql.com for guidance.

MySQL - memcached
-----------------

To take the load off the database, the whitetrash redirector can use memcached.  Just install cmemcached, and allocate some server memory.
List the memcache servers and enable use_memcached in whitetrash.conf.

To install memcached:

    sudo apt-get install libmemcache-dev libmemcache0 memcached
    wget http://gijsbert.org/downloads/cmemcache/cmemcache-0.95.tar.bz2

    Ignore the patch for libmemcache, you don't need it with the packaged version.

    cd cmemcache-0.95
    sudo python setup.py install

    Customise /etc/memcached

System
------

If you have a lot of users, you will have to make the standard system modifications to allow squid to consume lots of system resources::

    echo 8192 > /proc/sys/fs/file-max

Edit /etc/init.d/squid and put this at the very start::

    ulimit -HSn 8192

Edit /etc/default/squid (this is probably ubuntu/debian specific, you might find it in /etc/squid/squid.conf)::

    SQUID_MAXFD=8192

By default squid will fire up 5 instances of the redirector, you can change this, and if you have many users you will need a lot more.  Note that if you make this a large number you will probably want to increase the maximum number of mysql connections your mysql server will allow (100 by default).  You probably want lots of redirector processes in squid.conf::

    redirect_children 100

You may get complaints about too many connections being tracked, so::

    # This tell you how many sessions arte open right now.
    cat /proc/net/ip_conntrack | wc -l

    # This tells you the maximum number of conntrack entries you can have in total
    cat /proc/sys/net/ipv4/ip_conntrack_max

    echo 70000 > /proc/sys/net/ipv4/ip_conntrack_max

Edit /usr/include/bits/typesizes.h::

    #define _FD_SETSIZE            8192

And finally recompile::

    ./configure --with-maxfd=8192

Unfortunately despite doing all of this, I couldn't get squid to use more than 4096 file descriptors!  Look at syslog for any errors and warnings.

