=====================
Installing Whitetrash
=====================

Checkout the code:

    svn co https://whitetrash.svn.sourceforge.net/svnroot/whitetrash/trunk whitetrash

The packages you will need (this is an Ubuntu/debian command line, but other distros will be similar) are:

    sudo apt-get install \
    squid \
    python-dev \
    python-mysqldb \
    python-pyopenssl \
    mysql-server \
    python-django \
    libapache2-mod-python

    cd whitetrash

edit whitetrash.conf:

 - Change all of the database user passwords, these users will be created for you by the installation script

Run the setup script and supply your DB root password:

    sudo python setup.py install --mysql-root-passwd="myrootpassword"

Create ssl cert and enable apache ssl module (this is for self-signed, better if you buy one):

    a2enmod ssl rewrite
    sudo openssl genrsa -out /etc/apache2/ssl/server.key 4096
    #Use whitetrash as the common name
    sudo openssl req -new -key /etc/apache2/ssl/server.key -out server.csr
    sudo openssl x509 -req -days 365 -in server.csr -signkey /etc/apache2/ssl/server.key -out /etc/apache2/ssl/server.crt

Restart apache and squid.

If you would like to enable the CAPTCHA (http://en.wikipedia.org/wiki/Captcha) test for whitelist additions, you will need to install PyCAPTCHA: http://cheeseshop.python.org/pypi/PyCAPTCHA/0.4 and the python-imaging package (PIL).

Squid Config
~~~~~~~~~~~~

An example config with comments has been installed in /etc/squid/squid.conf, you probably don't need to change anything in here.
If you have a large network, check the performance section below.
This config is for Squid 2.7.STABLE3.  Your original squid.conf is backed up in the same directory.

The result
~~~~~~~~~~

netstat -plant should show you the following listeners:

- mysqld             127.0.0.1:3306
- squid              0.0.0.0:3128
- apache             0.0.0.0:80, 0.0.0.0:443

DNS
~~~

Make sure the following domains resolve to the whitetrash IP:

 - whitetrash
 - sslwhitetrash
 - blockedwhitetrash

You can do this with /etc/hosts if you don't have DNS:

    127.0.1.2   whitetrash
    127.0.1.3   sslwhitetrash
    127.0.1.4   blockedwhitetrash


===========
Performance
===========

Django
------

By default the whole web-interface uses SSL.  If this causes a performance problem you can drop back to HTTP for everything except for the login pages and admin interface by:

 - Removing the rewrite directives from /etc/apache2/sites-available/whitetrash
 - Setting SESSION_COOKIE_SECURE = False in settings.py

MySQL
-----

If you have a lot of users, you will want to look at tweaking your mysql install, in particular the max number of connections (100 by default).  Set max_connections in my.cnf or test on the commandline temporarily like this::

  set global max_connections=200;

You should probably allocate mysql some more system resources, as the defaults are fairly conservative.  See mysql.com for guidance.

MySQL - memcached
-----------------

To take the load off the database, the whitetrash redirector can use memcached.  Just install cmemcached, and allocate some server memory.
List the memcache servers and enable use_memcached in whitetrash.conf.

System
------

If you have a lot of users, you will have to make the standard system modifications to allow squid to consume lots of system resources::

    echo 8192 > /proc/sys/fs/file-max

Edit /etc/init.d/squid and put this at the very start::

    ulimit -HSn 8192

Edit /etc/default/squid (this is probably ubuntu/debian specific, you might find it in /etc/squid/squid.conf)::

    SQUID_MAXFD=8192

By default squid will fire up 5 instances of the redirector, you can change this, and if you have many users you will need a lot more.  Note that if you make this a large number you will probably want to increase the maximum number of mysql connections your mysql server will allow (100 by default).  You probably want lots of redirector processes in squid.conf::

    redirect_children 100

You may get complaints about too many connections being tracked, so::

    # This tell you how many sessions arte open right now.
    cat /proc/net/ip_conntrack | wc -l

    # This tells you the maximum number of conntrack entries you can have in total
    cat /proc/sys/net/ipv4/ip_conntrack_max

    echo 70000 > /proc/sys/net/ipv4/ip_conntrack_max

Edit /usr/include/bits/typesizes.h::

    #define _FD_SETSIZE            8192

And finally recompile::

    ./configure --with-maxfd=8192

Unfortunately despite doing all of this, I couldn't get squid to use more than 4096 file descriptors!  Look at syslog for any errors and warnings.

