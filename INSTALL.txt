=====================
Installing Whitetrash
=====================

Checkout the code:

  svn co https://whitetrash.svn.sourceforge.net/svnroot/whitetrash/trunk whitetrash

The packages you will need (this is an Ubuntu/debian command line, but other distros will be similar) are:

sudo apt-get install \
squid \
python-dev \
python-mysqldb \
python-pyopenssl \
mysql-server

If you would like to enable the CAPTCHA (http://en.wikipedia.org/wiki/Captcha) test for whitelist additions, you will need to install PyCAPTCHA: http://cheeseshop.python.org/pypi/PyCAPTCHA/0.4 and the python-imaging package (PIL).

Change the default password in db_setup.

Create and populate a database called 'whitetrash'. If this is a new mysql install, please set a root password::

  mysqladmin -u root password NEWPASSWORD

In mysql::
    
    mysql -u root -p
    create database whitetrash;
    use whitetrash;
    quit

This will install the whitetrash python files into /usr/bin, init script into /etc/init.d, and whitetrash.conf into /etc::

    sudo python setup.py install

If you intend to whitelist SSL you will need a certificate.  You can use the line below to create one, or buy one from a CA (this is better because then it will be automatically trusted by users).  The code expects the cert to be in /etc/server.pem.  The common name should be the same as whatever whitetrash_add_domain is set to in whitetrash.conf (default is whitetrash) :

    openssl req -new -x509 -keyout /etc/server.pem -out /etc/server.pem -days 365 -nodes

/etc/whitetrash.conf
~~~~~~~~~~~~~~~~~~~~

Edit /etc/whitetrash.conf to perform the necessary customisations.  The essential things you should change are:

- database_password

============
Squid Config
============

You will want to add the following lines to your squid.conf
 
- vimdiff example_configs/squid/squid.conf /etc/squid/squid.conf

See comments in the example config for more information.

==========
The result
==========

netstat -plant should show you the following listeners:

- mysqld             127.0.0.1:3306
- squid              0.0.0.0:3128

====================
In progress - django
====================

To use the django code:

sudo apt-get install \
python-django \
libapache2-mod-python

 - Copy the apache static files: cp -r example_configs/apache2/www/whitetrash /var/www/
 - Copy the whitetrash apache config:
    cp example_configs/apache2/whitetrash /etc/apache2/sites-available/
    cp example_configs/apache2/httpd.conf /etc/apache2/httpd.conf
 - Enable the whitetrash site: a2ensite whitetrash
 - Create ssl cert and enable apache ssl module:
    a2enmod ssl,rewrite
    mkdir /etc/apache2/ssl
    openssl genrsa -out /etc/apache2/ssl/server.key 4096
    openssl req -new -key /etc/apache2/ssl/server.key -out server.csr
    openssl x509 -req -days 365 -in server.csr -signkey /etc/apache2/ssl/server.key -out /etc/apache2/ssl/server.crt
 - Create a symlink: ln -s /usr/share/python-support/python-django/django/contrib/admin/media/ /var/www/whitetrash/media

Django config (create whitetrash db first):
 - cd django_site
 - python manage.py syncdb

Change django settings in settings.py, change redirector settings in whitetrash.conf

===========
Performance
===========

Django
------

By default the whole web-interface uses SSL.  If this causes a performance problem you can drop back to HTTP for everything except for the login pages and admin interface by:

 - Removing the rewrite directives from /etc/apache2/sites-available/whitetrash
 - Setting SESSION_COOKIE_SECURE = False in settings.py

MySQL
-----

If you have a lot of users, you will want to look at tweaking your mysql install, in particular the max number of connections (100 by default).  Set max_connections in my.cnf or test on the commandline temporarily like this::

  set global max_connections=200;

You should probably allocate mysql some more system resources, as the defaults are fairly conservative.  See mysql.com for guidance.

System
------

If you have a lot of users, you will have to make the standard system modifications to allow squid to consume lots of system resources::

    echo 8192 > /proc/sys/fs/file-max

Edit /etc/init.d/squid and put this at the very start::

    ulimit -HSn 8192

Edit /etc/default/squid (this is probably ubuntu/debian specific, you might find it in /etc/squid/squid.conf)::

    SQUID_MAXFD=8192

By default squid will fire up 5 instances of the redirector, you can change this, and if you have many users you will need a lot more.  Note that if you make this a large number you will probably want to increase the maximum number of mysql connections your mysql server will allow (100 by default).  You probably want lots of redirector processes in squid.conf::

    redirect_children 100

You may get complaints about too many connections being tracked, so::

    # This tell you how many sessions arte open right now.
    cat /proc/net/ip_conntrack | wc -l

    # This tells you the maximum number of conntrack entries you can have in total
    cat /proc/sys/net/ipv4/ip_conntrack_max

    echo 70000 > /proc/sys/net/ipv4/ip_conntrack_max

Edit /usr/include/bits/typesizes.h::

    #define _FD_SETSIZE            8192

And finally recompile::

    ./configure --with-maxfd=8192

Unfortunately despite doing all of this, I couldn't get squid to use more than 4096 file descriptors!  Look at syslog for any errors and warnings.

